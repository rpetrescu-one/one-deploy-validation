<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title></title>
    	<link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet">
	<style type="text/css">
		body {font-family: 'Ubuntu', sans-serif;}

		/* Table styling reused from FE report for consistency */
		.table_component {
		    overflow: auto;
		    width: 100%;
		    margin-top: 0.18in;
		    margin-bottom: 0.5in;
		}

		.table_component table {
		    border: 1px solid #dededf;
		    width: 100%;
		    table-layout: fixed;
		    border-collapse: collapse;
		    border-spacing: 1px;
		    text-align: left;
		    font-size: 11pt;
		}

		.table_component caption {
		    caption-side: top;
		    text-align: left;
		    font-weight: bold;
		    margin-bottom: 6px;
		}

		.table_component th {
		    border: 1px solid #dededf;
		    background-color: #eceff1;
		    color: #000000;
		    padding: 8px;
		    text-align: left;
		}

		.table_component td {
		    border: 1px solid #dededf;
		    background-color: #ffffff;
		    color: #000000;
		    padding: 8px;
		}

		/* Numeric columns should be right aligned */
		.table_component td.num, .table_component th.num { text-align: right; }

		/* Zebra rows */
		.table_component tr:nth-child(even) td { background: #fbfbfb; }

		/* Network tables should not span the full page - keep them readable */
		.network_table {
		    max-width: 760px; /* limits width so the table doesn't stretch full page */
		    /* pin to the left of the page */
		    margin-left: 0;
		    margin-right: auto;
		    width: auto;
		    table-layout: auto;
		    word-break: break-word;
		}

		@page { size: 8.5in 11in; margin-left: 1in; margin-right: 1in; margin-bottom: 0.5in }
		p { line-height: 115%; text-align: left; orphans: 0; widows: 0; margin-bottom: 0.1in; direction: ltr; background: transparent }
		h1 { line-height: 100%; text-align: justify; page-break-inside: auto; orphans: 0; widows: 0; margin-top: 0.33in; margin-bottom: 0.12in; direction: ltr; background: transparent; page-break-before: auto; page-break-after: auto }
		h1.western { font-size: 18pt; font-weight: bold }
		h1.cjk { font-size: 18pt; font-weight: bold }
		h1.ctl { font-size: 18pt }
		h2 { line-height: 100%; text-align: justify; page-break-inside: auto; orphans: 0; widows: 0; margin-top: 0.25in; margin-bottom: 0.10in; direction: ltr; background: transparent; page-break-before: auto; page-break-after: auto }
		h2.western { font-size: 14pt; font-weight: bold }
		h2.cjk { font-size: 14pt; font-weight: bold }
		h2.ctl { font-size: 14pt }
		a:link { color: #000080; text-decoration: underline }
	</style>
</head>
<body lang="en-US" link="#000080" vlink="#800000" bgcolor="#ffffff" dir="ltr">
<div title="header"><p style="page-break-inside: auto; orphans: 0; widows: 0; margin-bottom: 0in; border: none; padding: 0in; background: transparent; page-break-before: auto; page-break-after: auto">
	<br/>

	</p>

</div>
<h1 class="western">Appendix 1 - Automated Cloud Verification Report</h1>
<p style="margin-bottom: 0in; border: none; padding: 0in; background: transparent; page-break-before: auto; page-break-after: auto">
<br/>

</p>


</div></br>

<h2 class="western">Metadata</h2>
<p><b>Report generated:</b> {{ date }}</p>
<p><b>Repository version:</b> {{ repo_version }}</p>

<h2 class="western"><a name="_cgnw9t1vnxc8"></a> Verification of the OpenNebula cloud</h2></br>

{# Categorize verification results for better readability #}
{% set ns = namespace(
    core_services=[],
    vm_tests=[],
    vm_ha=[],
    fe_ha=[],
    federation=[],
    other=[]
) %}

{% for k, v in verification_result.items() %}
    {% if 'service' in k.lower() or 'opennebula version' in k.lower() or 'xml-rpc' in k.lower() %}
        {% set _ = ns.core_services.append((k, v)) %}
    {% elif 'test vm' in k.lower() or 'storage' in k.lower() and 'benchmark' not in k.lower() %}
        {% set _ = ns.vm_tests.append((k, v)) %}
    {% elif 'vm ha' in k.lower() or 'fencing' in k.lower() or 'host error' in k.lower() %}
        {% set _ = ns.vm_ha.append((k, v)) %}
    {% elif 'fe ha' in k.lower() or 'raft' in k.lower() or 'leader' in k.lower() %}
        {% set _ = ns.fe_ha.append((k, v)) %}
    {% elif 'federation' in k.lower() %}
        {% set _ = ns.federation.append((k, v)) %}
    {% else %}
        {% set _ = ns.other.append((k, v)) %}
    {% endif %}
{% endfor %}

{# Macro to render a table section #}
{% macro render_verification_table(items, section_title) %}
{% if items | length > 0 %}
<h3 class="western">{{ section_title }}</h3>
<table width="656" cellpadding="3" cellspacing="0" style="page-break-before: auto; page-break-after: auto; margin-bottom: 0.25in">
	<col width="281"/>
	<col width="200"/>
	<col width="260"/>
	<tr valign="top">
		<td width="300" bgcolor="#666666" style="background: #666666; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			<font color="#ffffff"><font size="3" style="font-size: 12pt"><b>Verification Point</b></font></font></p>
		</td>
		<td width="90" bgcolor="#666666" style="background: #666666; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			<font color="#ffffff"><font size="3" style="font-size: 12pt"><b>Result</b></font></font></p>
		</td>
		<td width="260" bgcolor="#666666" style="background: #666666; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			<font color="#ffffff"><font size="3" style="font-size: 12pt"><b>Comments</b></font></font></p>
		</td>
	</tr>
	{% for k, v in items %}
	<tr valign="top">
		<td width="300" height="21" style="background: transparent; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			<b>{{ k }}</b></p>
		</td>
		<td width="90" style="background: transparent; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			{{ v }}</p>
		</td>
		<td width="260" style="background: transparent; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			</p>
		</td>
	</tr>
	{% endfor %}
</table>
{% endif %}
{% endmacro %}

{# Render tables in logical order #}
{{ render_verification_table(ns.core_services, "Core Services") }}
{{ render_verification_table(ns.vm_tests, "VM Instantiation Tests") }}
{{ render_verification_table(ns.vm_ha, "VM High Availability") }}
{{ render_verification_table(ns.fe_ha, "Frontend High Availability") }}
{{ render_verification_table(ns.federation, "Federation Configuration") }}
{{ render_verification_table(ns.other, "Other Checks") }}

{% if all_federation_results is defined and all_federation_results | length > 0 %}
<h3 class="western">Federation Detailed Results (All Zones)</h3>
<p style="margin-bottom: 0.15in"><i>Consolidated federation validation results across all zones/frontends.</i></p>

{# Normalize check names by removing " on <hostname>" suffix and group by base check name #}
{% set ns_fed = namespace(normalized_checks={}) %}
{% for host, results in all_federation_results.items() %}
	{% for check, value in results.items() %}
		{# Remove " on <hostname>" from check name to normalize it #}
		{% set base_check = check | regex_replace(' on [^\\s]+$', '') %}
		{% if base_check not in ns_fed.normalized_checks %}
			{% set _ = ns_fed.normalized_checks.update({base_check: {}}) %}
		{% endif %}
		{# Store value for this host under the normalized check name #}
		{% set _ = ns_fed.normalized_checks[base_check].update({host: value}) %}
	{% endfor %}
{% endfor %}

{# Get list of hosts #}
{% set fed_hosts = all_federation_results.keys() | list %}

<div class="table_component" role="region" tabindex="0">
	<table style="border: 1px solid #dededf; width: 100%; border-collapse: collapse; border-spacing: 1px; font-size: 10pt;">
		<colgroup>
			<col style="width: 250px; min-width: 200px;">
			{% for host in fed_hosts %}
				<col style="width: auto;">
			{% endfor %}
		</colgroup>
		<tr>
			<th style="background-color: #666666; color: #ffffff; border: 1.00pt solid #000000; padding: 8px; text-align: left; font-size: 11pt; white-space: normal; word-wrap: break-word;">Check</th>
			{% for host in fed_hosts %}
				<th style="background-color: #666666; color: #ffffff; border: 1.00pt solid #000000; padding: 8px; text-align: center; font-size: 11pt; white-space: normal; word-wrap: break-word;">{{ host }}</th>
			{% endfor %}
		</tr>
		{% for check, host_values in ns_fed.normalized_checks.items() %}
		<tr>
			<td style="border: 1.00pt solid #000000; padding: 8px; font-weight: normal; font-size: 10pt; white-space: normal; word-wrap: break-word; vertical-align: top;">{{ check }}</td>
			{% for host in fed_hosts %}
				{% set result = host_values.get(host, 'N/A') %}
				{% set result_str = result|string|lower %}
				{# Determine status type for color coding #}
				{% if result == 'ok' or result == 'reachable' or result == 'active' or result == 'enabled' or result == 'running' or 'ok -' in result_str %}
					{% set status_color = '#d4edda' %}
				{% elif result == 'unreachable' or result == 'inactive' or result == 'failed' or result == 'unknown' or 'error' in result_str %}
					{% set status_color = '#f8d7da' %}
				{% elif 'warning' in result_str %}
					{% set status_color = '#fff3cd' %}
				{% elif result == 'N/A' %}
					{% set status_color = '#e9ecef' %}
				{% else %}
					{% set status_color = '#ffffff' %}
				{% endif %}
				<td style="background: {{ status_color }}; border: 1.00pt solid #000000; padding: 8px; text-align: center; font-size: 10pt; white-space: normal; word-wrap: break-word; vertical-align: top;">{{ result }}</td>
			{% endfor %}
		</tr>
		{% endfor %}
	</table>
</div>
{% endif %}
</div>

{% if storage_benchmark is defined and storage_benchmark | length > 0 %}
<div class="table_component" role="region" tabindex="0">

  <h2 class="western">Storage benchmarking results</h2>

	<!-- Compact storage benchmark: metrics as rows, hosts as columns -->
	{% set hosts = storage_benchmark.keys() | list %}

	<div style="display: block;">
	  <div style="width: 100%; margin-bottom: 1rem;">
	    <h3 class="western">Read metrics</h3>
	    <table class="network_table">
	      <tr>
	        <th>Metric</th>
	        {% for h in hosts %}
	          <th>{{ h }}</th>
	        {% endfor %}
	      </tr>
	      <tr><td>Blocksize (KB)</td>{% for h in hosts %}{% set r = storage_benchmark[h].read if (storage_benchmark[h].read is defined and storage_benchmark[h].read is not none) else {} %}
	        <td>
	          {% set bs_raw = r.bs | default(None) %}
	          {% if bs_raw %}
	            {% if bs_raw is string %}
	              {% set suffix = bs_raw[-1] %}
	              {% set num = (bs_raw[:-1]) | float(default=0) %}
	              {% if suffix in ['k','K'] %}
	                {% set kb = num %}
	              {% elif suffix in ['m','M'] %}
	                {% set kb = num * 1024 %}
	              {% elif suffix in ['g','G'] %}
	                {% set kb = num * 1024 * 1024 %}
	              {% else %}
	                {% set kb = (bs_raw | float) / 1024 %}
	              {% endif %}
	            {% else %}
	              {% set kb = (bs_raw | float) / 1024 %}
	            {% endif %}
	            {% set kb_str = ('%.2f'|format(kb)).rstrip('0').rstrip('.') %}
	            {{ kb_str }} KB
	          {% else %}
	            N/A
	          {% endif %}
	        </td>{% endfor %}</tr>
	      <tr><td>Bandwidth (MB/s)</td>{% for h in hosts %}{% set r = storage_benchmark[h].read if (storage_benchmark[h].read is defined and storage_benchmark[h].read is not none) else {} %}<td class="num">{{ r.bw_mbs | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>Completion latency (ms)</td>{% for h in hosts %}{% set r = storage_benchmark[h].read if (storage_benchmark[h].read is defined and storage_benchmark[h].read is not none) else {} %}<td class="num">{{ r.clat_ms | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>IO depth</td>{% for h in hosts %}{% set r = storage_benchmark[h].read if (storage_benchmark[h].read is defined and storage_benchmark[h].read is not none) else {} %}<td class="num">{{ r.iodepth | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>IOPS</td>{% for h in hosts %}{% set r = storage_benchmark[h].read if (storage_benchmark[h].read is defined and storage_benchmark[h].read is not none) else {} %}<td class="num">{{ r.iops | default('N/A') }}</td>{% endfor %}</tr>
	    </table>
	  </div>

	  <div style="width: 100%;">
	    <h3 class="western">Write metrics</h3>
	    <table class="network_table">
	      <tr>
	        <th>Metric</th>
	        {% for h in hosts %}
	          <th>{{ h }}</th>
	        {% endfor %}
	      </tr>
	      <tr><td>Blocksize (KB)</td>{% for h in hosts %}{% set w = storage_benchmark[h].write if (storage_benchmark[h].write is defined and storage_benchmark[h].write is not none) else {} %}
	        <td>
	          {% set bs_raw = w.bs | default(None) %}
	          {% if bs_raw %}
	            {% if bs_raw is string %}
	              {% set suffix = bs_raw[-1] %}
	              {% set num = (bs_raw[:-1]) | float(default=0) %}
	              {% if suffix in ['k','K'] %}
	                {% set kb = num %}
	              {% elif suffix in ['m','M'] %}
	                {% set kb = num * 1024 %}
	              {% elif suffix in ['g','G'] %}
	                {% set kb = num * 1024 * 1024 %}
	              {% else %}
	                {% set kb = (bs_raw | float) / 1024 %}
	              {% endif %}
	            {% else %}
	              {% set kb = (bs_raw | float) / 1024 %}
	            {% endif %}
	            {% set kb_str = ('%.2f'|format(kb)).rstrip('0').rstrip('.') %}
	            {{ kb_str }} KB
	          {% else %}
	            N/A
	          {% endif %}
	        </td>{% endfor %}</tr>
	      <tr><td>Bandwidth (MB/s)</td>{% for h in hosts %}{% set w = storage_benchmark[h].write if (storage_benchmark[h].write is defined and storage_benchmark[h].write is not none) else {} %}<td class="num">{{ w.bw_mbs | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>Completion latency (ms)</td>{% for h in hosts %}{% set w = storage_benchmark[h].write if (storage_benchmark[h].write is defined and storage_benchmark[h].write is not none) else {} %}<td class="num">{{ w.clat_ms | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>IO depth</td>{% for h in hosts %}{% set w = storage_benchmark[h].write if (storage_benchmark[h].write is defined and storage_benchmark[h].write is not none) else {} %}<td class="num">{{ w.iodepth | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>IOPS</td>{% for h in hosts %}{% set w = storage_benchmark[h].write if (storage_benchmark[h].write is defined and storage_benchmark[h].write is not none) else {} %}<td class="num">{{ w.iops | default('N/A') }}</td>{% endfor %}</tr>
	    </table>
	  </div>
	</div>

	</div>
</div>
{% endif %}

{% if network_benchmark is defined and network_benchmark | length > 0 %}
<div class="table_component" role="region" tabindex="0">
	<h2 class="western">Network benchmarking results</h2>

	<h2>Throughput (iperf3)</h2>
		<table class="network_table">
		<caption>Per-client to server throughput measured with iperf3</caption>
		<tr>
			<th>Client host</th>
			<th>Server (ip)</th>
			<th class="num">Throughput (Mbps)</th>
		</tr>
		{% for host, data in network_benchmark.items() %}
			{% if data.iperf_results is defined and data.iperf_results.results is defined %}
				{% for it in data.iperf_results.results %}
					{% set bps = it.stdout | default('0') | float %}
					{% set mbps = (bps / 1000000.0) | round(2) %}
					<tr>
						<td>{{ host }}</td>
						{# try to resolve the server IP to a hostname using hostvars; fall back to the IP #}
												{% if ip_to_hostname is defined %}
													{% set server_name = ip_to_hostname.get(it.item) %}
												{% else %}
													{% set server_name = None %}
												{% endif %}
												<td>{{ server_name | default(it.item) }}</td>
						<td class="num">{{ '%.2f'|format(mbps) }} Mbps</td>
					</tr>
				{% endfor %}
			{% else %}
				<tr><td colspan="3">No iperf3 results for {{ host }}</td></tr>
			{% endif %}
		{% endfor %}
	</table>

	<h2>Ping (average RTT)</h2>
	<table class="network_table">
		<caption>Average round-trip time measured with ping (jc)</caption>
		<tr>
			<th>Source host</th>
			<th>Destination</th>
			<th class="num">Avg RTT (ms)</th>
		</tr>
		{% for host, data in network_benchmark.items() %}
			{% if data.ping_exec is defined and data.ping_exec.results is defined %}
				{% for it in data.ping_exec.results %}
					{% set rtt_raw = it.stdout | default('') %}
					{% if rtt_raw != '' and rtt_raw != 'null' %}
						{% set rtt = (rtt_raw | float) | round(2) %}
						<tr>
							<td>{{ host }}</td>
							{# try to resolve destination IP to hostname, fall back to IP #}
														{% if ip_to_hostname is defined %}
															{% set dest_name = ip_to_hostname.get(it.item) %}
														{% else %}
															{% set dest_name = None %}
														{% endif %}
														<td>{{ dest_name | default(it.item) }}</td>
							<td class="num">{{ '%.2f'|format(rtt) }} ms</td>
						</tr>
					{% else %}
						<tr>
							<td>{{ host }}</td>
							<td>{{ it.item }}</td>
							<td class="num">N/A</td>
						</tr>
					{% endif %}
				{% endfor %}
			{% else %}
				<tr><td colspan="3">No ping results for {{ host }}</td></tr>
			{% endif %}
		{% endfor %}
	</table>
</div>
{% endif %}

{% if conn_results_matrix is defined and conn_results_matrix | length > 0 %}
<div class="table_component" role="region" tabindex="0">
	<h2 class="western">Connectivity Matrix</h2>

	<table class="network_table" border="1">
		<caption>Connectivity Matrix: Packet Loss Percentages Between VMs deployed on the hosts.</caption>
		<thead>
			<tr>
				<th>From \ To</th>
				{% set all_hosts = conn_results_matrix.keys() | list %}
				{% for dst in all_hosts %}
					<th>{{ dst }}</th>
				{% endfor %}
			</tr>
		</thead>
		<tbody>
			{% for src in all_hosts %}
				<tr>
					<td><b>{{ src }}</b></td>
					{% for dst in all_hosts %}
						{% if src == dst %}
							<td style="background:#eee">â€”</td>
						{% else %}
							{# Find the result dict for src->dst #}
							{% set result_element = (conn_results_matrix[src] | dict2items | selectattr('key', 'search', dst + '.json$') | map(attribute='value') | list) %}
							{% if result_element | length != 1 %}
								<td style="background:yellow">Warning: {{ result_element | length }} results (expected 1)</td>
							{% else %}
								{% set result = result_element | first %}
								{% if result.packet_loss_percent is defined %}
									<td style="background:{{ 'lightgreen' if result.packet_loss_percent == 0.0 else 'lightcoral' }}">
										{{ result.packet_loss_percent }}%
									</td>
								{% else %}
									<td style="background:lightcoral">missing</td>
								{% endif %}
							{% endif %}
						{% endif %}
					{% endfor %}
				</tr>
			{% endfor %}
		</tbody>
	</table>
</div>
{% endif %}

<h2 class="western">Variables used for the validation</h2>
<pre>{{ validation_vars | to_nice_yaml }}</pre>

</body>
</html>
