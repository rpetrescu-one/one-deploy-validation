<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title></title>
    	<link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet">
	<style type="text/css">
		body {font-family: 'Ubuntu', sans-serif;}

		/* Table styling reused from FE report for consistency */
		.table_component {
		    overflow: auto;
		    width: 100%;
		    margin-top: 0.18in;
		    margin-bottom: 0.5in;
		}

		.table_component table {
		    border: 1px solid #dededf;
		    width: 100%;
		    table-layout: fixed;
		    border-collapse: collapse;
		    border-spacing: 1px;
		    text-align: left;
		    font-size: 11pt;
		}

		.table_component caption {
		    caption-side: top;
		    text-align: left;
		    font-weight: bold;
		    margin-bottom: 6px;
		}

		.table_component th {
		    border: 1px solid #dededf;
		    background-color: #eceff1;
		    color: #000000;
		    padding: 8px;
		    text-align: left;
		}

		.table_component td {
		    border: 1px solid #dededf;
		    background-color: #ffffff;
		    color: #000000;
		    padding: 8px;
		}

		/* Numeric columns should be right aligned */
		.table_component td.num, .table_component th.num { text-align: right; }

		/* Zebra rows */
		.table_component tr:nth-child(even) td { background: #fbfbfb; }

		/* Network tables should not span the full page - keep them readable */
		.network_table {
		    max-width: 760px; /* limits width so the table doesn't stretch full page */
		    /* pin to the left of the page */
		    margin-left: 0;
		    margin-right: auto;
		    width: auto;
		    table-layout: auto;
		    word-break: break-word;
		}

		@page { size: 8.5in 11in; margin-left: 1in; margin-right: 1in; margin-bottom: 0.5in }
		p { line-height: 115%; text-align: left; orphans: 0; widows: 0; margin-bottom: 0.1in; direction: ltr; background: transparent }
		h1 { line-height: 100%; text-align: justify; page-break-inside: auto; orphans: 0; widows: 0; margin-top: 0.33in; margin-bottom: 0.12in; direction: ltr; background: transparent; page-break-before: auto; page-break-after: auto }
		h1.western { font-size: 18pt; font-weight: bold }
		h1.cjk { font-size: 18pt; font-weight: bold }
		h1.ctl { font-size: 18pt }
		h2 { line-height: 100%; text-align: justify; page-break-inside: auto; orphans: 0; widows: 0; margin-top: 0.25in; margin-bottom: 0.10in; direction: ltr; background: transparent; page-break-before: auto; page-break-after: auto }
		h2.western { font-size: 14pt; font-weight: bold }
		h2.cjk { font-size: 14pt; font-weight: bold }
		h2.ctl { font-size: 14pt }
		a:link { color: #000080; text-decoration: underline }
	</style>
</head>
<body lang="en-US" link="#000080" vlink="#800000" bgcolor="#ffffff" dir="ltr">
<div title="header"><p style="page-break-inside: auto; orphans: 0; widows: 0; margin-bottom: 0in; border: none; padding: 0in; background: transparent; page-break-before: auto; page-break-after: auto">
	<br/>

	</p>

</div>
<h1 class="western">Appendix 1 - Automated Cloud Verification Report</h1>
<p style="margin-bottom: 0in; border: none; padding: 0in; background: transparent; page-break-before: auto; page-break-after: auto">
<br/>

</p>


</div></br>

<h2 class="western">Metadata</h2>
<p><b>Report generated:</b> {{ date }}</p>
<p><b>Repository version:</b> {{ repo_version }}</p>

<h2 class="western"><a name="_cgnw9t1vnxc8"></a> Verification of the OpenNebula cloud</h2></br>

<table width="656" cellpadding="3" cellspacing="0" style="page-break-before: auto; page-break-after: auto">
	
	<col width="281"/>
	<col width="200"/>
	<col width="260"/>
	<tr valign="top">
		
		<td width="300" bgcolor="#666666" style="background: #666666; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			<font color="#ffffff"><font size="3" style="font-size: 12pt"><b>Verification
			Point</b></font></font></p>
		</td>
		<td width="90" bgcolor="#666666" style="background: #666666; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			<font color="#ffffff"><font size="3" style="font-size: 12pt"><b>Result</b></font></font></p>
		</td>
		<td width="260" bgcolor="#666666" style="background: #666666; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			<font color="#ffffff"><font size="3" style="font-size: 12pt"><b>Comments</b></font></font></p>
		</td>
	</tr>
         {% for k, v in verification_result.items() %}	
	<tr valign="top">
		<td width="300" height="21" style="background: transparent; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			<b>{{ k }}</b></p>
		</td>
		<td width="90" style="background: transparent; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			{{ v }}</p>
		</td>
		<td width="260" style="background: transparent; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">

			</p>
		</td>
	</tr>
	{% endfor %}

	</p>
</table>
</div>


{% if validation_vars['networks_verification'] == true and network_verification_results | length > 0 %}

<div class="table_component" role="region" tabindex="0">

  <h2 class="western">Virtual Networks validation results</h2>
<table width="656" cellpadding="3" cellspacing="0" style="page-break-before: auto; page-break-after: auto">
       <col width="281"/>
        <col width="200"/>
        <col width="260"/>
        <tr valign="top">

                <td width="300" bgcolor="#666666" style="background: #666666; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
                        <font color="#ffffff"><font size="3" style="font-size: 12pt"><b>Network name</b></font></font></p>
                </td>
                <td width="90" bgcolor="#666666" style="background: #666666; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
                        <font color="#ffffff"><font size="3" style="font-size: 12pt"><b>Result</b></font></font></p>
                </td>
                <td width="260" bgcolor="#666666" style="background: #666666; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
                        <font color="#ffffff"><font size="3" style="font-size: 12pt"><b>Comments</b></font></font></p>
                </td>
        </tr>
         {% for k, v in network_verification_results.items() %}
        <tr valign="top">
                <td width="300" height="21" style="background: transparent; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			<b>{{ k }}</b></p>
                </td>
                <td width="90" style="background: transparent; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">
			{% for test, value in v.items() %}
                        <b>{{ test }}</b>: {{ value }}</p>
                        {% endfor %}
                </td>
                <td width="260" style="background: transparent; border: 1.00pt solid #000000; padding: 0.07in"><p align="left" style="page-break-inside: auto; orphans: 0; widows: 0; border: none; padding: 0in; background: transparent; page-break-after: auto">

                        </p>
                </td>
        </tr>
        {% endfor %}

        </p>
</table>
</div>

{% endif %}



{% if storage_benchmark is defined and storage_benchmark | length > 0 %}
<div class="table_component" role="region" tabindex="0">

  <h2 class="western">Storage benchmarking results</h2>

	<!-- Compact storage benchmark: metrics as rows, hosts as columns -->
	{% set hosts = storage_benchmark.keys() | list %}

	<div style="display: block;">
	  <div style="width: 100%; margin-bottom: 1rem;">
	    <h3 class="western">Read metrics</h3>
	    <table class="network_table">
	      <tr>
	        <th>Metric</th>
	        {% for h in hosts %}
	          <th>{{ h }}</th>
	        {% endfor %}
	      </tr>
	      <tr><td>Blocksize (KB)</td>{% for h in hosts %}{% set r = storage_benchmark[h].read if (storage_benchmark[h].read is defined and storage_benchmark[h].read is not none) else {} %}
	        <td>
	          {% set bs_raw = r.bs | default(None) %}
	          {% if bs_raw %}
	            {% if bs_raw is string %}
	              {% set suffix = bs_raw[-1] %}
	              {% set num = (bs_raw[:-1]) | float(default=0) %}
	              {% if suffix in ['k','K'] %}
	                {% set kb = num %}
	              {% elif suffix in ['m','M'] %}
	                {% set kb = num * 1024 %}
	              {% elif suffix in ['g','G'] %}
	                {% set kb = num * 1024 * 1024 %}
	              {% else %}
	                {% set kb = (bs_raw | float) / 1024 %}
	              {% endif %}
	            {% else %}
	              {% set kb = (bs_raw | float) / 1024 %}
	            {% endif %}
	            {% set kb_str = ('%.2f'|format(kb)).rstrip('0').rstrip('.') %}
	            {{ kb_str }} KB
	          {% else %}
	            N/A
	          {% endif %}
	        </td>{% endfor %}</tr>
	      <tr><td>Bandwidth (MB/s)</td>{% for h in hosts %}{% set r = storage_benchmark[h].read if (storage_benchmark[h].read is defined and storage_benchmark[h].read is not none) else {} %}<td class="num">{{ r.bw_mbs | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>Completion latency (ms)</td>{% for h in hosts %}{% set r = storage_benchmark[h].read if (storage_benchmark[h].read is defined and storage_benchmark[h].read is not none) else {} %}<td class="num">{{ r.clat_ms | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>IO depth</td>{% for h in hosts %}{% set r = storage_benchmark[h].read if (storage_benchmark[h].read is defined and storage_benchmark[h].read is not none) else {} %}<td class="num">{{ r.iodepth | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>IOPS</td>{% for h in hosts %}{% set r = storage_benchmark[h].read if (storage_benchmark[h].read is defined and storage_benchmark[h].read is not none) else {} %}<td class="num">{{ r.iops | default('N/A') }}</td>{% endfor %}</tr>
	    </table>
	  </div>

	  <div style="width: 100%;">
	    <h3 class="western">Write metrics</h3>
	    <table class="network_table">
	      <tr>
	        <th>Metric</th>
	        {% for h in hosts %}
	          <th>{{ h }}</th>
	        {% endfor %}
	      </tr>
	      <tr><td>Blocksize (KB)</td>{% for h in hosts %}{% set w = storage_benchmark[h].write if (storage_benchmark[h].write is defined and storage_benchmark[h].write is not none) else {} %}
	        <td>
	          {% set bs_raw = w.bs | default(None) %}
	          {% if bs_raw %}
	            {% if bs_raw is string %}
	              {% set suffix = bs_raw[-1] %}
	              {% set num = (bs_raw[:-1]) | float(default=0) %}
	              {% if suffix in ['k','K'] %}
	                {% set kb = num %}
	              {% elif suffix in ['m','M'] %}
	                {% set kb = num * 1024 %}
	              {% elif suffix in ['g','G'] %}
	                {% set kb = num * 1024 * 1024 %}
	              {% else %}
	                {% set kb = (bs_raw | float) / 1024 %}
	              {% endif %}
	            {% else %}
	              {% set kb = (bs_raw | float) / 1024 %}
	            {% endif %}
	            {% set kb_str = ('%.2f'|format(kb)).rstrip('0').rstrip('.') %}
	            {{ kb_str }} KB
	          {% else %}
	            N/A
	          {% endif %}
	        </td>{% endfor %}</tr>
	      <tr><td>Bandwidth (MB/s)</td>{% for h in hosts %}{% set w = storage_benchmark[h].write if (storage_benchmark[h].write is defined and storage_benchmark[h].write is not none) else {} %}<td class="num">{{ w.bw_mbs | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>Completion latency (ms)</td>{% for h in hosts %}{% set w = storage_benchmark[h].write if (storage_benchmark[h].write is defined and storage_benchmark[h].write is not none) else {} %}<td class="num">{{ w.clat_ms | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>IO depth</td>{% for h in hosts %}{% set w = storage_benchmark[h].write if (storage_benchmark[h].write is defined and storage_benchmark[h].write is not none) else {} %}<td class="num">{{ w.iodepth | default('N/A') }}</td>{% endfor %}</tr>
	      <tr><td>IOPS</td>{% for h in hosts %}{% set w = storage_benchmark[h].write if (storage_benchmark[h].write is defined and storage_benchmark[h].write is not none) else {} %}<td class="num">{{ w.iops | default('N/A') }}</td>{% endfor %}</tr>
	    </table>
	  </div>
	</div>

	</div>
</div>
{% endif %}

{% if network_benchmark is defined and network_benchmark | length > 0 %}
<div class="table_component" role="region" tabindex="0">
	<h2 class="western">Network benchmarking results</h2>

	<h2>Throughput (iperf3)</h2>
		<table class="network_table">
		<caption>Per-client to server throughput measured with iperf3</caption>
		<tr>
			<th>Client host</th>
			<th>Server (ip)</th>
			<th class="num">Throughput (Mbps)</th>
		</tr>
		{% for host, data in network_benchmark.items() %}
			{% if data.iperf_results is defined and data.iperf_results.results is defined %}
				{% for it in data.iperf_results.results %}
					{% set bps = it.stdout | default('0') | float %}
					{% set mbps = (bps / 1000000.0) | round(2) %}
					<tr>
						<td>{{ host }}</td>
						{# try to resolve the server IP to a hostname using hostvars; fall back to the IP #}
												{% if ip_to_hostname is defined %}
													{% set server_name = ip_to_hostname.get(it.item) %}
												{% else %}
													{% set server_name = None %}
												{% endif %}
												<td>{{ server_name | default(it.item) }}</td>
						<td class="num">{{ '%.2f'|format(mbps) }} Mbps</td>
					</tr>
				{% endfor %}
			{% else %}
				<tr><td colspan="3">No iperf3 results for {{ host }}</td></tr>
			{% endif %}
		{% endfor %}
	</table>

	<h2>Ping (average RTT)</h2>
	<table class="network_table">
		<caption>Average round-trip time measured with ping (jc)</caption>
		<tr>
			<th>Source host</th>
			<th>Destination</th>
			<th class="num">Avg RTT (ms)</th>
		</tr>
		{% for host, data in network_benchmark.items() %}
			{% if data.ping_exec is defined and data.ping_exec.results is defined %}
				{% for it in data.ping_exec.results %}
					{% set rtt_raw = it.stdout | default('') %}
					{% if rtt_raw != '' and rtt_raw != 'null' %}
						{% set rtt = (rtt_raw | float) | round(2) %}
						<tr>
							<td>{{ host }}</td>
							{# try to resolve destination IP to hostname, fall back to IP #}
														{% if ip_to_hostname is defined %}
															{% set dest_name = ip_to_hostname.get(it.item) %}
														{% else %}
															{% set dest_name = None %}
														{% endif %}
														<td>{{ dest_name | default(it.item) }}</td>
							<td class="num">{{ '%.2f'|format(rtt) }} ms</td>
						</tr>
					{% else %}
						<tr>
							<td>{{ host }}</td>
							<td>{{ it.item }}</td>
							<td class="num">N/A</td>
						</tr>
					{% endif %}
				{% endfor %}
			{% else %}
				<tr><td colspan="3">No ping results for {{ host }}</td></tr>
			{% endif %}
		{% endfor %}
	</table>
</div>
{% endif %}

{% if conn_results_matrix is defined and conn_results_matrix | length > 0 %}
<div class="table_component" role="region" tabindex="0">
	<h2 class="western">Connectivity Matrix</h2>

	<table class="network_table" border="1">
		<caption>Connectivity Matrix: Packet Loss Percentages Between VMs deployed on the hosts.</caption>
		<thead>
			<tr>
				<th>From \ To</th>
				{% set all_hosts = conn_results_matrix.keys() | list %}
				{% for dst in all_hosts %}
					<th>{{ dst }}</th>
				{% endfor %}
			</tr>
		</thead>
		<tbody>
			{% for src in all_hosts %}
				<tr>
					<td><b>{{ src }}</b></td>
					{% for dst in all_hosts %}
						{% if src == dst %}
							<td style="background:#eee">â€”</td>
						{% else %}
							{# Find the result dict for src->dst #}
							{% set result_element = (conn_results_matrix[src] | dict2items | selectattr('key', 'search', dst + '.json$') | map(attribute='value') | list) %}
							{% if result_element | length != 1 %}
								<td style="background:yellow">Warning: {{ result_element | length }} results (expected 1)</td>
							{% else %}
								{% set result = result_element | first %}
								{% if result.packet_loss_percent is defined %}
									<td style="background:{{ 'lightgreen' if result.packet_loss_percent == 0.0 else 'lightcoral' }}">
										{{ result.packet_loss_percent }}%
									</td>
								{% else %}
									<td style="background:lightcoral">missing</td>
								{% endif %}
							{% endif %}
						{% endif %}
					{% endfor %}
				</tr>
			{% endfor %}
		</tbody>
	</table>
</div>
{% endif %}

<h2 class="western">Variables used for the validation</h2>
<pre>{{ validation_vars | to_nice_yaml }}</pre>

</body>
</html>
